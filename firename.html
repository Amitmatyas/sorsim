<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>שינוי שם מסמך ב-Firestore</title>
    <!-- Favicon - Lightning Bolt SVG -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M13 2L3 14h9l-1 8 10-12h-9l1-8z'%3E%3C/path%3E%3C/svg%3E" type="image/svg+xml">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom CSS for animations and enhanced styling -->
    <style>
        /* Import Google Font - Inter for a modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        /* Base styles for the body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Prevent scroll on subtle background animations */
            position: relative; /* Needed for pseudo-element background */
            direction: ltr; /* Ensure Left-to-Right layout */
        }

        /* Subtle background animation */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Animated gradient for a vibrant feel - faster and larger */
            background: linear-gradient(45deg, #e0f2fe, #eef2ff, #f3e8ff, #ede9fe, #dff0f6, #e7eefd);
            background-size: 600% 600%; /* Larger background for more noticeable movement */
            animation: gradientBackground 10s ease infinite; /* Faster, smooth, infinite animation */
            z-index: 1; /* Behind content */
        }

        @keyframes gradientBackground {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Main container styling for the form */
        .container {
            background-color: #ffffff;
            border-radius: 20px; /* More rounded corners */
            padding: 40px;
            /* Enhanced shadow for a floating effect */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 15px rgba(0, 0, 0, 0.05);
            max-width: 500px;
            width: 90%;
            border: 1px solid #e2e8f0; /* Subtle border */
            position: relative;
            z-index: 10; /* Ensure it's above the background animation */
            animation: fadeInScale 0.7s ease-out forwards; /* Entry animation */
        }

        /* Animation for the container on load */
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Title specific animations - pulsing glow and subtle bounce */
        h1 {
            animation: textGlow 1.5s infinite alternate, textShake 0.5s infinite alternate; /* Added textShake */
            text-shadow: 0 0 5px rgba(99, 102, 241, 0.5), 0 0 10px rgba(99, 102, 241, 0.3);
        }

        @keyframes textGlow {
            from {
                text-shadow: 0 0 5px rgba(99, 102, 241, 0.5), 0 0 10px rgba(99, 102, 241, 0.3);
                transform: scale(1);
            }
            to {
                text-shadow: 0 0 10px rgba(99, 102, 241, 0.7), 0 0 20px rgba(99, 102, 241, 0.5);
                transform: scale(1.02);
            }
        }

        @keyframes textShake {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-1px) translateY(-1px); }
            75% { transform: translateX(1px) translateY(1px); }
        }


        /* Styling for input fields and select */
        .input-field {
            border: 1px solid #cbd5e1; /* Light grey border */
            border-radius: 10px; /* Rounded input fields */
            padding: 12px 16px;
            font-size: 1rem;
            color: #333;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease, background-color 0.3s ease; /* Added background-color */
            text-align: left; /* Ensure text within inputs is LTR */
            background-color: #f8fafc; /* Light background for inputs */
        }

        .input-field:focus {
            outline: none;
            border-color: #6366f1; /* Indigo focus border */
            box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.4), 0 0 20px rgba(99, 102, 241, 0.3); /* Stronger glow on focus */
            transform: translateY(-3px) scale(1.005); /* More pronounced lift on focus */
            background-color: #ffffff; /* White background on focus */
        }

        /* Styling for labels */
        label {
            text-align: left; /* Ensure labels align left */
        }

        /* Styling for the primary button */
        .btn-primary {
            /* Vibrant gradient background */
            background: linear-gradient(135deg, #6366f1, #8b5cf6); /* Indigo to Violet */
            color: white;
            padding: 14px 28px;
            border-radius: 12px; /* More rounded button */
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease; /* Smooth transitions for hover effects */
            /* Deep shadow for a prominent look */
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3), 0 4px 6px rgba(99, 102, 241, 0.1);
            position: relative; /* For ripple effect */
            overflow: hidden; /* For ripple effect */
            animation: pulseEffect 2s infinite ease-in-out; /* Continuous pulsing effect */
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-5px); /* More dramatic lift effect on hover */
            /* More intense shadow on hover */
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.6), 0 8px 12px rgba(99, 102, 241, 0.3);
            /* Slightly different gradient on hover for visual feedback */
            background: linear-gradient(135deg, #7c3aed, #a78bfa);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(2px) scale(0.95); /* More pronounced press down effect on click */
            box-shadow: 0 5px 10px rgba(99, 102, 241, 0.2);
            transition: transform 0.1s ease-out; /* Quick transition for click */
            animation: none; /* Stop pulsing during active state */
        }

        .btn-primary:disabled {
            background: #a5b4fc; /* Lighter disabled state */
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            animation: none; /* Stop pulsing when disabled */
        }

        /* Ripple effect for button click */
        .btn-primary .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8); /* White ripple, slightly more opaque */
            animation: ripple-animation 0.7s linear forwards; /* Slightly longer ripple */
            transform: scale(0);
            pointer-events: none;
            opacity: 0;
        }

        @keyframes ripple-animation {
            from {
                transform: scale(0);
                opacity: 1;
            }
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Continuous pulsing effect for the primary button */
        @keyframes pulseEffect {
            0% { transform: scale(1); box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3), 0 4px 6px rgba(99, 102, 241, 0.1); }
            50% { transform: scale(1.015); box-shadow: 0 15px 30px rgba(99, 102, 241, 0.5), 0 6px 10px rgba(99, 102, 241, 0.2); }
            100% { transform: scale(1); box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3), 0 4px 6px rgba(99, 102, 241, 0.1); }
        }

        /* Styling for the secondary button (Load Documents) */
        .btn-secondary {
            background: linear-gradient(135deg, #a78bfa, #c4b5fd); /* Light purple gradient */
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            box-shadow: 0 5px 10px rgba(167, 139, 250, 0.3);
            display: flex; /* For alignment with input field */
            align-items: center; /* Center text vertically */
            justify-content: center; /* Center text horizontally */
        }
        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(167, 139, 250, 0.4);
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
        }
        .btn-secondary:disabled {
            background: #d8c9ff;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }


        /* Styling for message display boxes */
        .message-box {
            padding: 15px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            text-align: center;
            margin-top: 25px;
            animation: slideInUpBounce 0.8s ease-out forwards; /* Message entry animation with pronounced bounce */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* Subtle shadow for message box */
        }

        /* Animation for message boxes - combines slide in with a pronounced bounce */
        @keyframes slideInUpBounce {
            0% {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            70% {
                opacity: 1;
                transform: translateY(-5px) scale(1.05); /* Larger overshoot for bounce */
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message-box.success {
            background-color: #d1fae5; /* Green 100 */
            color: #065f46; /* Green 700 */
            border: 1px solid #34d399; /* Green 300 */
        }

        .message-box.error {
            background-color: #fee2e2; /* Red 100 */
            color: #991b1b; /* Red 700 */
            border: 1px solid #f87171; /* Red 300 */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .container {
                padding: 25px;
                border-radius: 15px;
            }
            .btn-primary {
                padding: 12px 20px;
                font-size: 1rem;
            }
            .input-field {
                padding: 10px 14px;
            }
            h1 {
                font-size: 2rem; /* Adjust title size for smaller screens */
            }
            .flex-col-md {
                flex-direction: column; /* Stack elements on smaller screens */
            }
            .md\:w-auto {
                width: 100%; /* Make button full width on small screens */
            }
            .md\:mt-0 {
                margin-top: 1rem; /* Add some margin when stacked */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-8 text-center leading-tight">
            ⚡️ שינוי שם מסמך ב-Firestore ⚡️
        </h1>

        <p class="text-sm text-gray-600 mb-6 text-center">
            משתמש מחובר (ID): <span id="userIdDisplay" class="font-semibold text-blue-700 break-all text-xs">טוען...</span>
        </p>

        <div class="mb-5 flex flex-col md:flex-row gap-4">
            <div class="flex-grow">
                <label for="collectionName" class="block text-gray-700 text-sm font-bold mb-2">
                    שם האוסף (Collection Name):
                </label>
                <input
                    type="text"
                    id="collectionName"
                    class="input-field w-full"
                    placeholder="לדוגמה: users"
                />
            </div>
            <button
                id="loadDocumentsButton"
                class="btn-secondary mt-auto py-2 px-4 rounded-lg font-bold text-sm h-12 flex-shrink-0 md:mt-0"
            >
                טען מסמכים
            </button>
        </div>

        <div class="mb-5">
            <label for="oldDocId" class="block text-gray-700 text-sm font-bold mb-2">
                ID של המסמך הישן:
            </label>
            <select
                id="oldDocId"
                class="input-field w-full"
                disabled
            >
                <option value="">אנא טען מסמכים ראשית...</option>
            </select>
        </div>

        <div class="mb-8">
            <label for="newDocId" class="block text-gray-700 text-sm font-bold mb-2">
                ID חדש למסמך:
            </label>
            <input
                type="text"
                id="newDocId"
                class="input-field w-full"
                placeholder="לדוגמה: new_user456"
            />
        </div>

        <button
            id="renameButton"
            class="btn-primary w-full"
            disabled
        >
            שנה שם מסמך
        </button>

        <div id="messageDisplay" class="message-box hidden"></div>

        <p class="text-xs text-gray-500 mt-8 text-center">
            *שים לב: קוד זה משנה מסמך בנתיב פרטי: `/artifacts/{appId}/users/{userId}/{collectionName}/{docId}`.
            וודא שיש לך הרשאות כתיבה וקריאה מתאימות ב-Firestore Security Rules.
        </p>
    </div>

    <!-- Firebase SDKs - Loaded as ES Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration - provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyDlyDbpwcBcWvFnvYHb84dMEpaQFTjv-HY",
            authDomain: "tester-69fa9.firebaseapp.com",
            projectId: "tester-69fa9",
            storageBucket: "tester-69fa9.firebasestorage.app",
            messagingSenderId: "378563229004",
            appId: "1:378563229004:web:5136b724eb84fd00e44be9",
            measurementId: "G-BFJ1QQM3MS"
        };

        // Global variables for Firebase instances
        let db;
        let auth;
        let currentUserId = null;
        let isFirebaseReady = false;

        // Global variable for the app ID, provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Get references to HTML elements
        const collectionNameInput = document.getElementById('collectionName');
        const oldDocIdSelect = document.getElementById('oldDocId'); // Now a select element
        const newDocIdInput = document.getElementById('newDocId');
        const renameButton = document.getElementById('renameButton');
        const loadDocumentsButton = document.getElementById('loadDocumentsButton');
        const messageDisplay = document.getElementById('messageDisplay');
        const userIdDisplay = document.getElementById('userIdDisplay');

        /**
         * Displays a message to the user in the message box.
         * @param {string} message - The message text.
         * @param {boolean} isError - True if it's an error message, false for success/info.
         */
        function showMessage(message, isError = false) {
            messageDisplay.textContent = message;
            messageDisplay.classList.remove('hidden', 'success', 'error'); // Remove previous classes
            messageDisplay.classList.add(isError ? 'error' : 'success'); // Add new class
        }

        /**
         * Initializes Firebase app, Firestore, and Authentication.
         * Authenticates the user.
         */
        async function initializeFirebase() {
            try {
                // Initialize Firebase with the provided config
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Get the initial auth token from the environment, if available
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth); // Sign in anonymously if no custom token
                }

                // Set the current user ID, falling back to a random UUID if not available
                currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                userIdDisplay.textContent = currentUserId; // Display user ID in the UI
                showMessage('Firebase אוסף ומתחבר בהצלחה.', false); // Success message
                isFirebaseReady = true; // Mark Firebase as ready
                renameButton.disabled = false; // Enable rename button once Firebase is ready
            } catch (error) {
                console.error("שגיאה באתחול Firebase או בהתחברות:", error);
                showMessage(`שגיאה באתחול/התחברות ל-Firebase: ${error.message}. וודא שאימות אנונימי מופעל בפרויקט Firebase שלך.`, true); // Error message
                renameButton.disabled = true; // Keep button disabled on error
                loadDocumentsButton.disabled = true; // Disable load documents button on error
            }
        }

        /**
         * Adds a ripple effect to the button on click.
         * @param {Event} e - The click event.
         */
        function createRipple(e) {
            const button = e.currentTarget;
            const ripple = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            ripple.style.width = ripple.style.height = `${diameter}px`;
            ripple.style.left = `${e.clientX - button.offsetLeft - radius}px`;
            ripple.style.top = `${e.clientY - button.offsetTop - radius}px`;
            ripple.classList.add('ripple');

            const existingRipple = button.querySelector('.ripple');
            if (existingRipple) {
                existingRipple.remove(); // Remove previous ripple if exists
            }
            button.appendChild(ripple);
        }

        /**
         * Loads document IDs from the specified collection into the dropdown.
         */
        async function loadDocuments() {
            if (!isFirebaseReady || !db || !currentUserId) {
                showMessage('שגיאה: Firebase אינו מאותחל או שאין משתמש.', true);
                return;
            }
            const collectionName = collectionNameInput.value.trim();
            if (!collectionName) {
                showMessage('אנא הזן שם אוסף כדי לטעון מסמכים.', true);
                return;
            }

            oldDocIdSelect.innerHTML = '<option value="">טוען מסמכים...</option>'; // Loading state
            oldDocIdSelect.disabled = true;
            loadDocumentsButton.disabled = true;
            renameButton.disabled = true; // Disable rename button while loading
            showMessage('טוען מסמכים מהאוסף...');

            try {
                // Construct the collection reference based on the app's security rules.
                const collectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`);
                const querySnapshot = await getDocs(collectionRef); // Fetch all documents in the collection

                if (querySnapshot.empty) {
                    oldDocIdSelect.innerHTML = '<option value="">אין מסמכים באוסף זה</option>';
                    showMessage(`אין מסמכים באוסף '${collectionName}'.`, true);
                } else {
                    oldDocIdSelect.innerHTML = '<option value="">בחר מסמך...</option>'; // Reset dropdown
                    querySnapshot.forEach(doc => {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = doc.id;
                        oldDocIdSelect.appendChild(option);
                    });
                    showMessage(`נמצאו ${querySnapshot.docs.length} מסמכים באוסף '${collectionName}'.`, false);
                }
                oldDocIdSelect.disabled = false; // Enable dropdown
            } catch (error) {
                console.error("שגיאה בטעינת מסמכים:", error);
                showMessage(`שגיאה בטעינת מסמכים: ${error.message}. וודא ששם האוסף נכון ושיש לך הרשאות קריאה.`, true);
                oldDocIdSelect.innerHTML = '<option value="">שגיאה בטעינה</option>';
            } finally {
                loadDocumentsButton.disabled = false; // Re-enable load documents button
                renameButton.disabled = false; // Re-enable rename button
            }
        }


        /**
         * Handles the document renaming process.
         * Reads the old document, creates a new one with the new ID, and then deletes the old one.
         */
        async function handleRenameDocument() {
            // Check if Firebase is initialized and user is authenticated
            if (!isFirebaseReady || !db || !currentUserId) {
                showMessage('שגיאה: Firebase אינו מאותחל או שאין משתמש.', true);
                return;
            }
            const collectionName = collectionNameInput.value.trim();
            const oldDocId = oldDocIdSelect.value; // Get selected value from dropdown
            const newDocId = newDocIdInput.value.trim();

            // Validate input fields and selected document
            if (!collectionName || !oldDocId || !newDocId || oldDocId === '' || newDocId === '') {
                showMessage('אנא מלא את כל השדות: שם אוסף, בחר ID קיים ו-ID חדש.', true);
                return;
            }

            renameButton.disabled = true; // Disable button during operation
            loadDocumentsButton.disabled = true; // Disable load documents button during rename
            showMessage('מבצע שינוי...'); // Show loading message

            try {
                // Construct the document references based on the app's security rules.
                const oldDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`, oldDocId);
                const newDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`, newDocId);

                // 1. Read the old document data
                const oldDocSnap = await getDoc(oldDocRef);

                // Check if the old document exists
                if (!oldDocSnap.exists()) {
                    showMessage(`שגיאה: המסמך '${oldDocId}' באוסף '${collectionName}' לא נמצא.`, true);
                    return; // Stop execution if document not found
                }

                const oldDocData = oldDocSnap.data(); // Get the data from the old document

                // 2. Create a new document with the new ID and the old data
                await setDoc(newDocRef, oldDocData);

                // 3. Delete the old document
                await deleteDoc(oldDocRef);

                // Success message
                showMessage(`המסמך '${oldDocId}' שונה בהצלחה ל- '${newDocId}' באוסף '${collectionName}'.`, false);

                // After successful rename, reload documents to reflect the change
                loadDocuments();

            } catch (error) {
                // Log and display any errors during the process
                console.error("שגיאה בשינוי שם המסמך:", error);
                showMessage(`שגיאה בשינוי שם המסמך: ${error.message}`, true);
            } finally {
                renameButton.disabled = false; // Re-enable the rename button
                loadDocumentsButton.disabled = false; // Re-enable load documents button
            }
        }

        // Add event listeners when the DOM content is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase(); // Initialize Firebase when the page loads
            loadDocumentsButton.addEventListener('click', loadDocuments); // Attach click event to load documents button
            renameButton.addEventListener('click', (e) => {
                createRipple(e); // Create ripple effect on click
                handleRenameDocument(); // Then handle the document rename
            });
        });
    </script>
</body>
</html>
